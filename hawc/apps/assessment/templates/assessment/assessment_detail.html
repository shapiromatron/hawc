{% extends 'assessment-rooted.html' %}

{% load hastext %}

{% block content %}
  <h2 class="d-inline-block">{{object}}</h2>
  {% if crud == "Read" %}
    <div class="dropdown btn-group float-right">
      <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown">Actions</a>
      <div class="dropdown-menu dropdown-menu-right">

        <!-- assessment editing -->
        {% if obj_perms.edit %}
          <span class="dropdown-header">Assessment Editing</span>
          {% if obj_perms.edit_assessment %}
          <a class="dropdown-item" href="{% url 'assessment:update' object.pk %}">Update assessment</a>
          <a class="dropdown-item" href="{% url 'assessment:modules_update' object.pk %}">Update enabled modules</a>
          <a class="dropdown-item" href="{% url 'assessment:delete' object.pk %}">Delete assessment</a>
          {% endif %}
          <a class="dropdown-item" href="{{ object.get_clear_cache_url }}">Clear assessment cache</a>
          <a class="dropdown-item" href="{{ object.get_assessment_logs_url }}">Change logs</a>
          <button class="dropdown-item" hx-get="{% url 'assessment:attachment-create' object.pk %}"
          hx-trigger="click" hx-target="#attach_table" hx-swap="outerHTML">
          Add an attachment</button>
          <a class="dropdown-item" href="{% url 'assessment:dataset_create' object.pk %}">Add a dataset</a>
          <div class="dropdown-divider"></div>
        {% else %}
          {% if obj_perms.edit_assessment %}
            {% comment "User has permission but assessment is locked" %}{% endcomment %}
            <span class="dropdown-header">Assessment Editing</span>
            <a class="dropdown-item" href="{% url 'assessment:update' object.pk %}">Update assessment</a>
            <div class="dropdown-divider"></div>
          {% endif %}
        {% endif %}

        <!-- application settings -->
        <span class="dropdown-header">Application settings</span>
        {% if assessment.enable_risk_of_bias %}
        <a class="dropdown-item" href="{% url 'riskofbias:arob_detail' pk=object.pk %}">{{object.get_rob_name_display}} settings</a>
        {% endif %}

        {% if assessment.enable_bmd %}
        <a class="dropdown-item" href="{% url 'bmd:assess_settings_detail' pk=object.pk %}">Benchmark dose settings</a>
        {% endif %}

        {% if assessment.enable_data_extraction and obj_perms.edit_assessment %}
        <a class="dropdown-item" href="{% url 'invitro:endpointcategory_update' object.pk %}">Update IV endpoint categories</a>
        {% endif%}

        <!-- data cleanup -->
        {% if assessment.enable_data_extraction and obj_perms.edit_assessment or assessment.enable_risk_of_bias and obj_perms.edit_assessment %}
        <div class="dropdown-divider"></div>
        <span class="dropdown-header">Data cleanup views</span>
            {% if assessment.enable_data_extraction %}
            <a class="dropdown-item" href="{% url 'assessment:clean_extracted_data' object.pk %}">Clean extracted data</a>
            {% endif%}
            {% if assessment.enable_risk_of_bias and obj_perms.edit_assessment %}
            <a class="dropdown-item" href="{% url 'assessment:clean_study_metrics' pk=object.pk %}">Clean {{object.get_rob_name_display|lower}} responses</a>
            {% endif %}
        {% endif %}

      </div>
    </div>
  {% endif %}

  <table id="assessment_table" class="table table-sm table-striped">
    <colgroup>
      <col style="width: 30%;">
      <col style="width: 70%;">
    </colgroup>
    <tbody>

      <tr>
        <th>Assessment name</th>
        <td>{{object.name}}</td>
      </tr>

      {% if object.cas %}
        <tr>
          <th>CASRN</th>
          <td>{{object.cas}}</td>
        </tr>
      {% endif %}

      {% if object.dtxsids.count > 0 %}
          <tr>
            <th>DSSTox substance identifiers (DTXSID)</th>
            <td id="dtxsid-app"></td>
          </tr>
      {% endif %}

      <tr>
        <th>Year</th>
        <td>{{object.year}}</td>
      </tr>

      <tr>
        <th>Version</th>
        <td>{{object.version}}</td>
      </tr>

      {% if object.assessment_objective %}
      <tr>
        <th>Assessment objective</th>
        <td>{{object.assessment_objective|safe}}</td>
      </tr>
      {% endif %}

      {% if object.authors %}
      <tr>
        <th>Assessment authors</th>
        <td>{{object.authors|safe}}</td>
      </tr>
      {% endif %}

      {% if object.conflicts_of_interest %}
      <tr>
        <th>Conflicts of interest</th>
        <td>{{object.conflicts_of_interest|safe}}</td>
      </tr>
      {% endif %}

      {% if object.funding_source %}
      <tr>
        <th>Funding source</th>
        <td>{{object.funding_source|safe}}</td>
      </tr>
      {% endif %}

      {% if object.vocabulary %}
      <tr>
        <th>Vocabulary</th>
        <td>{{object.get_vocabulary_display}}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  {% if obj_perms.edit %}
  <h3>Assessment details for team members</h3>
  <table id="assessment_table" class="table table-sm table-striped">
    <colgroup>
      <col style="width: 19%;">
      <col style="width: 27%;">
      <col style="width: 27%;">
      <col style="width: 27%;">
    </colgroup>
    <tbody>
      <tr>
        <th>Assessment team*</th>
        <td>
          <p><strong><u>Project manager{{ object.project_manager.all|pluralize }}</u></strong></p>
          <ul class="mb-0">
            {% for m in object.project_manager.all %}
              <li>{{ m.get_full_name }}</li>
            {% endfor %}
          </ul>
        </td>
        <td>
          <p><strong><u>Team member{{ object.team_members.all|pluralize }}</u></strong></p>
          <ul class="mb-0">
            {% for m in object.team_members.all %}
            <li>{{ m.get_full_name }}</li>
            {% empty %}
            <li><i>None assigned</i></li>
            {% endfor %}
          </ul>
        </td>
        <td>
          <p><strong><u>Reviewer{{ object.reviewers.all|pluralize }}</u></strong></p>
          <ul class="mb-0">
            {% for m in object.reviewers.all %}
            <li>{{ m.get_full_name }}</li>
            {% empty %}
            <li><i>None assigned</i></li>
            {% endfor %}
          </ul>
        </td>
      </tr>

      <tr>
        <th>Editable*</th>
        <td colspan="3">{{object.editable}}</td>
      </tr>

      <tr>
        <th>Public*</th>
        <td colspan="3">
          {% if object.public_on %}
          Yes; published on {{object.public_on|date:"DATE_FORMAT"}}
          {% else %}
          No; this assessment is currently private
          {% endif %}
        </td>
      </tr>

      {% if object.public_on %}
      <tr>
        <th>Hidden from public assessments page?*</th>
        <td colspan="3">{{object.hide_from_public_page|yesno:"Yes; available if you have the link but hidden from the list page,No; it's available via searching or browsing"|safe}}</td>
      </tr>
      {% endif %}

      {% if internal_communications|hastext %}
      <tr>
        <th>Internal communications*</th>
        <td colspan="3">{{ internal_communications|safe }}</td>
      </tr>
      {% endif %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="5" class="text-muted">
          * These fields are only shown to assessment team members, even if the assessment is made public.
        </td>
      </tr>
    </tfoot>
  </table>
  {% endif %}

  {% if crud == "Read" %}
    {% include "assessment/fragments/attachment_list.html" with object_list=attachments canEdit=obj_perms.edit_assessment %}
    {% include "assessment/_dataset_list.html" with object_list=datasets %}
  {% endif %}

{% endblock content %}

{% block extrajs %}
{% if crud == "Read" and object.dtxsids.first %}
<script type="text/javascript">
  $(document).on('ready', function () {
    const dtxsids = {{dtxsids|safe}},
      el = document.getElementById('dtxsid-app');
    window.app.startup("assessmentStartup", function(app){
      app.renderDssToxTabs(el, dtxsids);
    });
  });
</script>
{% endif %}
<script type="text/javascript">
  htmx.onLoad(function (target) {
    // attachment-form events
    const form = $(target).find('.attachment-form');
    if (form) {
      form.find('.html5text').quillify();
      form.find("#id_title").focus();
    }
  });
</script>
{% endblock extrajs %}
